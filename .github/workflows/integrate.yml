name: Jest Coverage Report for All Commits

on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 1  # Solo obtiene el Ãºltimo commit del push

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '14'

      - name: Get commit history in push
        run: |
          git fetch --prune --unshallow  # Hacer el repositorio "shallow" para obtener el historial
          git rev-list --reverse --no-merges HEAD..origin/main > commits.txt

      - name: Run Jest for each commit
        run: |
          commits=$(cat commits.txt)
          for commit in $commits; do
            echo "Running tests for commit: $commit"

            # Recorremos los commits uno por uno y ejecutamos Jest
            git checkout $commit
            npm install
            npm test -- --coverage --ci --runInBand

            # Publicar reporte de cobertura utilizando el plugin
            echo "Publishing coverage report for commit: $commit"
            jest-coverage-report-action --github-token=${{ secrets.GITHUB_TOKEN }} --commit=$commit
          done
